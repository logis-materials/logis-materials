<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§‘í•˜ì¥ ìŠ¤ë§ˆíŠ¸ ì‹¤ì‹œê°„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ìŠ¤íƒ€ì¼ (ì œê³µí•´ì£¼ì‹  ìŠ¤íƒ€ì¼ ìœ ì§€) */
        body { font-family: 'Pretendard', -apple-system, sans-serif; padding: 10px; background: #f4f7f6; color: #333; margin: 0; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #28a745; padding-bottom: 15px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        h2 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .btn-group { display: flex; gap: 5px; }
        button { padding: 10px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; }
        .excel-btn { background: #1d6f42; color: white; }
        .admin-auth-btn { background: #666; color: white; }
        .save-btn { background: #28a745; color: white; width: 100%; font-size: 15px; margin-top: 5px; }
        .stock-panel { background: #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; }
        .stock-item { background: #444; padding: 5px 10px; border-radius: 4px; border-left: 3px solid #28a745; font-size: 13px; }
        .stock-item b { color: #5cb85c; }
        .input-group { margin-bottom: 15px; display: flex; gap: 8px; flex-direction: column; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .input-row { display: flex; gap: 8px; }
        .input-row > * { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: center; font-size: 13px; }
        th { background: #f8f9fa; color: #666; }
        .edit-btn { background: #ffc107; padding: 5px 8px; margin-right: 2px; border-radius: 4px; }
        .del-btn { background: #dc3545; color: white; padding: 5px 8px; border-radius: 4px; }
        @media screen and (max-width: 600px) {
            .header h2 { font-size: 1rem; }
            .input-row { flex-direction: column; }
            .btn-group button { padding: 8px; font-size: 11px; }
            td { padding: 10px 5px; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ“¦ ìì¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
        <div class="btn-group">
            <button class="excel-btn" onclick="downloadExcel()">ì—‘ì…€ì €ì¥</button>
            <button id="adminBtn" class="admin-auth-btn" onclick="toggleAdmin()">ê´€ë¦¬ì</button>
        </div>
    </div>

    <div id="stockPanel" class="stock-panel"></div>
    
    <div class="input-group">
        <div class="input-row">
            <select id="location">
                <option value="">-- ì§‘í•˜ì¥ --</option>
                <option value="ìš©ì¸ì§‘í•˜ì¥">ìš©ì¸ì§‘í•˜ì¥</option>
                <option value="ì²­ë¼ì§‘í•˜ì¥">ì²­ë¼ì§‘í•˜ì¥</option>
                <option value="ì†¡ë„ì§‘í•˜ì¥">ì†¡ë„ì§‘í•˜ì¥</option>
                <option value="ì°½ì›ì§‘í•˜ì¥">ì°½ì›ì§‘í•˜ì¥</option>
                <option value="ì†¡íŒŒì§‘í•˜ì¥">ì†¡íŒŒì§‘í•˜ì¥</option>
                <option value="ë…¸ì›ì§‘í•˜ì¥">ë…¸ì›ì§‘í•˜ì¥</option>
                <option value="ê°•ì„œì§‘í•˜ì¥">ê°•ì„œì§‘í•˜ì¥</option>
                <option value="ê´‘ì£¼ì§‘í•˜ì¥">ê´‘ì£¼ì§‘í•˜ì¥</option>
                <option value="ì „ì£¼ì§‘í•˜ì¥">ì „ì£¼ì§‘í•˜ì¥</option>
                <option value="ì„œëŒ€ë¬¸ì§‘í•˜ì¥">ì„œëŒ€ë¬¸ì§‘í•˜ì¥</option>
                <option value="ëŒ€ì „(ëŒ€ë•)ì§‘í•˜ì¥">ëŒ€ì „(ëŒ€ë•)ì§‘í•˜ì¥</option>
                <option value="ë¶€ì‚°(ê¸°ì¥)ì§‘í•˜ì¥">ë¶€ì‚°(ê¸°ì¥)ì§‘í•˜ì¥</option>
                <option value="ë¶€ì‚°(ì‚¬ìƒ)ì§‘í•˜ì¥">ë¶€ì‚°(ì‚¬ìƒ)ì§‘í•˜ì¥</option>
                <option value="ëŒ€êµ¬(ë‹¬ì„±)ì§‘í•˜ì¥">ëŒ€êµ¬(ë‹¬ì„±)ì§‘í•˜ì¥</option>
                <option value="ëŒ€êµ¬(ë¶êµ¬)ì§‘í•˜ì¥">ëŒ€êµ¬(ë¶êµ¬)ì§‘í•˜ì¥</option>
                <option value="ìš¸ì‚°(ì˜¨ì‚°)ì§‘í•˜ì¥">ìš¸ì‚°(ì˜¨ì‚°)ì§‘í•˜ì¥</option>
                <option value="ìš¸ì‚°(ìš¸ì£¼)ì§‘í•˜ì¥">ìš¸ì‚°(ìš¸ì£¼)ì§‘í•˜ì¥</option>
            </select>
            <input type="text" id="itemName" placeholder="ìì¬ëª… (ê³ ì²  ë“±)">
        </div>
        <div class="input-row">
            <select id="type"><option value="ì…ê³ ">ğŸ“¥ ì…ê³ </option><option value="ì¶œê³ ">ğŸ“¤ ì¶œê³ </option></select>
            <input type="number" id="amount" placeholder="ìˆ˜ëŸ‰">
        </div>
        <button class="save-btn" onclick="addItem()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
    </div>

    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
        <select id="viewFilter" onchange="loadData()" style="padding:8px; border-radius:6px; border:1px solid #28a745; font-weight:bold;">
            <option value="ì „ì²´">ì „ì²´ ë³´ê¸°</option>
            <option value="ìš©ì¸ì§‘í•˜ì¥">ìš©ì¸ì§‘í•˜ì¥</option>
                <option value="ì²­ë¼ì§‘í•˜ì¥">ì²­ë¼ì§‘í•˜ì¥</option>
                <option value="ì†¡ë„ì§‘í•˜ì¥">ì†¡ë„ì§‘í•˜ì¥</option>
                <option value="ì°½ì›ì§‘í•˜ì¥">ì°½ì›ì§‘í•˜ì¥</option>
                <option value="ì†¡íŒŒì§‘í•˜ì¥">ì†¡íŒŒì§‘í•˜ì¥</option>
                <option value="ë…¸ì›ì§‘í•˜ì¥">ë…¸ì›ì§‘í•˜ì¥</option>
                <option value="ê°•ì„œì§‘í•˜ì¥">ê°•ì„œì§‘í•˜ì¥</option>
                <option value="ê´‘ì£¼ì§‘í•˜ì¥">ê´‘ì£¼ì§‘í•˜ì¥</option>
                <option value="ì „ì£¼ì§‘í•˜ì¥">ì „ì£¼ì§‘í•˜ì¥</option>
                <option value="ì„œëŒ€ë¬¸ì§‘í•˜ì¥">ì„œëŒ€ë¬¸ì§‘í•˜ì¥</option>
                <option value="ëŒ€ì „(ëŒ€ë•)ì§‘í•˜ì¥">ëŒ€ì „(ëŒ€ë•)ì§‘í•˜ì¥</option>
                <option value="ë¶€ì‚°(ê¸°ì¥)ì§‘í•˜ì¥">ë¶€ì‚°(ê¸°ì¥)ì§‘í•˜ì¥</option>
                <option value="ë¶€ì‚°(ì‚¬ìƒ)ì§‘í•˜ì¥">ë¶€ì‚°(ì‚¬ìƒ)ì§‘í•˜ì¥</option>
                <option value="ëŒ€êµ¬(ë‹¬ì„±)ì§‘í•˜ì¥">ëŒ€êµ¬(ë‹¬ì„±)ì§‘í•˜ì¥</option>
                <option value="ëŒ€êµ¬(ë¶êµ¬)ì§‘í•˜ì¥">ëŒ€êµ¬(ë¶êµ¬)ì§‘í•˜ì¥</option>
                <option value="ìš¸ì‚°(ì˜¨ì‚°)ì§‘í•˜ì¥">ìš¸ì‚°(ì˜¨ì‚°)ì§‘í•˜ì¥</option>
                <option value="ìš¸ì‚°(ìš¸ì£¼)ì§‘í•˜ì¥">ìš¸ì‚°(ìš¸ì£¼)ì§‘í•˜ì¥</option>
        </select>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ë‚ ì§œ/ì‹œê°„</th>
                    <th>ì§‘í•˜ì¥</th>
                    <th>ìì¬</th>
                    <th>êµ¬ë¶„</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th id="adminHeader" style="display:none;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="logTable"></tbody>
        </table>
    </div>
</div>

<script>
    // Firebase ì •ë³´
    const firebaseConfig = {
        apiKey: "AIzaSyATmK6cTrla_-W1_PQueX0ItsVNqaADcB4",
        authDomain: "logis-materials.firebaseapp.com",
        projectId: "logis-materials",
        storageBucket: "logis-materials.firebasestorage.app",
        messagingSenderId: "659994464620",
        appId: "1:659994464620:web:c7a90dc68706b557ed6349"
    };

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let isAdmin = false;
    const ADMIN_PW = "1234";
    let globalData = []; // ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš© ë°ì´í„° ì €ì¥

    window.onload = function() { loadData(); };

    // ë°ì´í„° ì‹¤ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadData() {
        const filterValue = document.getElementById('viewFilter').value;
        let query = db.collection("materialLogs").orderBy("timestamp", "desc");

        // í•„í„°ê°€ 'ì „ì²´'ê°€ ì•„ë‹ˆë©´ ì¿¼ë¦¬ì— ì¡°ê±´ ì¶”ê°€
        if (filterValue !== "ì „ì²´") {
            query = query.where("location", "==", filterValue);
        }

        query.onSnapshot((snapshot) => {
            globalData = [];
            snapshot.forEach((doc) => {
                globalData.push({ id: doc.id, ...doc.data() });
            });
            renderTable(globalData);
        });
    }

    // ê¸°ë¡ ì¶”ê°€ (Firebase ì €ì¥)
    function addItem() {
        const location = document.getElementById('location').value;
        const name = document.getElementById('itemName').value;
        const type = document.getElementById('type').value;
        const amount = document.getElementById('amount').value;

        if(!location || !name || !amount) { alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

        const now = new Date();
        const dateString = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;

        db.collection("materialLogs").add({
            date: dateString,
            location: location,
            name: name,
            type: type,
            amount: parseInt(amount),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('itemName').value = '';
            document.getElementById('amount').value = '';
        }).catch((error) => {
            alert("ì €ì¥ ì‹¤íŒ¨: " + error);
        });
    }

    // ìˆ˜ì • ê¸°ëŠ¥ (Firebase ì—…ë°ì´íŠ¸)
    function editItem(id) {
        if(!isAdmin) return;
        const item = globalData.find(i => i.id === id);
        if(item) {
            const newName = prompt("ìˆ˜ì •í•  ìì¬ëª…:", item.name);
            const newAmount = prompt("ìˆ˜ì •í•  ìˆ˜ëŸ‰:", item.amount);
            if(newName && newAmount) {
                db.collection("materialLogs").doc(id).update({
                    name: newName,
                    amount: parseInt(newAmount)
                });
            }
        }
    }

    // ì‚­ì œ ê¸°ëŠ¥ (Firebase ì‚­ì œ)
    function deleteItem(id) {
        if(!isAdmin) return;
        if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.collection("materialLogs").doc(id).delete();
        }
    }

    // í™”ë©´ ê·¸ë¦¬ê¸°
    function renderTable(data) {
        const tableBody = document.getElementById('logTable');
        const stockPanel = document.getElementById('stockPanel');
        
        document.getElementById('adminHeader').style.display = isAdmin ? 'table-cell' : 'none';

        // ì¬ê³  ê³„ì‚°
        const summary = {};
        data.forEach(i => {
            summary[i.name] = (summary[i.name] || 0) + (i.type === "ì…ê³ " ? i.amount : -i.amount);
        });
        
        stockPanel.innerHTML = "";
        Object.keys(summary).forEach(n => stockPanel.innerHTML += `<div class="stock-item">${n}: <b>${summary[n]}</b></div>`);
        if(Object.keys(summary).length === 0) stockPanel.innerHTML = "<div style='font-size:12px;color:#888;'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";

        tableBody.innerHTML = "";
        data.forEach(i => {
            const row = tableBody.insertRow();
            let actionButtons = isAdmin ? `<td><button class="edit-btn" onclick="editItem('${i.id}')">âœ</button><button class="del-btn" onclick="deleteItem('${i.id}')">âœ˜</button></td>` : "";
            row.innerHTML = `<td>${i.date}</td><td>${i.location}</td><td><strong>${i.name}</strong></td><td style="color:${i.type==='ì¶œê³ '?'red':'blue'}">${i.type}</td><td>${i.amount.toLocaleString()}</td>${actionButtons}`;
        });
    }

    function toggleAdmin() {
        if (!isAdmin) {
            if (prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:") === ADMIN_PW) {
                isAdmin = true;
                document.getElementById('adminBtn').innerText = "ë¡œê·¸ì•„ì›ƒ";
                document.getElementById('adminBtn').style.background = "#28a745";
            } else { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); }
        } else {
            isAdmin = false;
            document.getElementById('adminBtn').innerText = "ê´€ë¦¬ì";
            document.getElementById('adminBtn').style.background = "#666";
        }
        renderTable(globalData);
    }

    function downloadExcel() {
        if (globalData.length === 0) { alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        let csvContent = "\uFEFFë‚ ì§œ,ì§‘í•˜ì¥,ìì¬ëª…,êµ¬ë¶„,ìˆ˜ëŸ‰\n"; 
        globalData.forEach(i => { csvContent += `${i.date},${i.location},${i.name},${i.type},${i.amount}\n`; });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `ìì¬ê´€ë¦¬_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }
</script>
</body>
</html>